# Laravel 6+ wrapper for IAM by m7 s.r.o.
This package provides simple wrapper for comunicating with IAM created by m7 s.r.o. 
inside Laravel 6+ applications.

## Installation
### Basic steps
1. Install via composer: `composer require m7/iam`
1. Run migrations: `php artisan migrate` - this creates (or updates) some fields to `users` table that are
used to pair your users with IAM:
    1. `iam_uid`
    1. `name`
    1. `surname`
    1. `email`

### Additional steps
#### Fillable properties
Fields generated by migration from this package should be added to fillable property on your `User` model, 
like so:
```php
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use Authenticatable;

    protected $fillable = ['iam_uid', 'name', 'surname', 'email', 'password'];
}
```
#### Trait
Next up, you should use `Iam` trait in your user model

```php
use Illuminate\Foundation\Auth\User as Authenticatable;
use m7\Iam\Traits\Iam;

class User extends Authenticatable
{
    use Authenticatable, Iam;

    protected $fillable = ['iam_uid', 'name', 'surname', 'email', 'password'];
}
```
## Configuration
### .env values
```dotenv
IAM_MANAGER_SERVER=https://server.url
IAM_MANAGER_CLIENT_ID=XXXXX
IAM_MANAGER_CLIENT_SECRET=XXXXX
IAM_MANAGER_REDIRECT_URL=/success # url to which user is redirected after successfull login
```
### Middleware
This is not required, but very useful. You can register middleware shipped with this package to protect
certain routes or route groups based on scopes assigned to users in IAM.

To do so, register `IamScopes` middleware in your `app/Http/Kernel.php`:

```php
protected $routeMiddleware = [
    ...
    'iam.scopes' => IamScopes::class,
    ...
];
```
Also, do not forget to add `use` directive with correct namespace before the `Kernel` class: <br/>
`use m7\Iam\Http\Middleware\IamScopes;`
## Usage

### Basic
You can always get instance of iam manager class via helper function `iam_manager()` if you need to do so.

There is one route for login created, which you should use to login your users
```php
Route::post('iam/login', 'LoginController@login')->name('iam.manager.login');
```
Request body for this route should contain `username` and `password` keys with corresponding values.

Alternatively, if you do not want to use this particular route for some reason, you can login your user via
manager helper instance `iam_manager()->login($username, $password)`

`iam_manager()->login` method returns instance of `User` model if successfully logged in, `false` otherwise.

### Trait methods
If you successfully added `Iam` trait to user model, you can now access several methods:
```php
Auth::user()->getScopes() // get all scopes assigned to this user
Auth::user()->hasScope($scope) // check if user has certain scope ($scope can also be array, that way you can check if user has multiple scopes)
```

### Middleware
If you registered middleware during configuration, you can protect routes or route groups based on scopes
provided by IAM.
#### Single scope
Example usage of `iam.scopes` middleware for single scope could look like this
```php
Route::middleware('iam.scopes:auth.users.manage')->group(function () {
    Route::get('users/manage', function() {
        echo "This route is scope protected";
    });
})
```
#### Multiple scopes
You can also use multiple scopes. Just separate them with pipe (`|`), and you can use as many scopes as you want:
```php
Route::middleware('iam.scopes:auth.users.manage|auth.groups.view')->group(function () {
    Route::get('users/manage', function() {
        echo "This route is scope protected";
    });
})
```
